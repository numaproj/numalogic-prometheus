apiVersion: numaflow.numaproj.io/v1alpha1
kind: Pipeline
metadata:
  name: numalogic-prometheus-pipeline
spec:
  watermark:
    disabled: true
  limits:
    readBatchSize: 100
    bufferMaxLength: 1000
    bufferUsageLimit: 100
  vertices:
    - name: input
      source:
        http:
          service: true
    - name: decode
      scale:
        min: 1
        max: 1
      udf:
        container:
          image: quay.io/numaio/numaflow-udf/prometheus-serde
    - name: filter
      scale:
        min: 1
        max: 1
      udf:
        container:
          image: quay.io/numaio/numalogic-prometheus/udf:v0.1.0a0
          args:
            - python
            - starter.py
            - udf
            - metric_filter
    - name: window
      scale:
        min: 1
        max: 1
      udf:
        container:
          image: quay.io/numaio/numalogic-prometheus/udf:v0.1.0a0
          args:
            - python
            - starter.py
            - udf
            - window
          env:
            - name: REDIS_HOST
              value: numalogic-redis-cluster.numalogic-prometheus.svc.cluster.local
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_AUTH
              value: "5rmmfXtsbL"
      limits:
        readBatchSize: 1
    - name: preprocess
      scale:
        min: 1
        max: 5
      udf:
        container:
          image: quay.io/numaio/numalogic-prometheus/udf:v0.1.0a0
          args:
            - python
            - starter.py
            - udf
            - preprocess
    - name: inference
      scale:
        min: 1
        max: 5
      udf:
        container:
          image: quay.io/numaio/numalogic-prometheus/udf:v0.1.0a0
          args:
            - python
            - starter.py
            - udf
            - inference
          env:
            - name: TRACKING_URI
              value: "http://mlflow-service.numalogic-prometheus.svc.cluster.local:5000"
      metadata:
        annotations:
          iam.amazonaws.com/role: <MLFLOW_S3_ROLE_ARN>
    - name: threshold
      scale:
        min: 1
        max: 5
      udf:
        container:
          image: quay.io/numaio/numalogic-prometheus/udf:v0.1.0a0
          args:
            - python
            - starter.py
            - udf
            - threshold
    - name: postprocess
      scale:
        min: 1
        max: 5
      udf:
        container:
          image: quay.io/numaio/numalogic-prometheus/udf:v0.1.0a0
          args:
            - python
            - starter.py
            - udf
            - postprocess
          env:
            - name: REDIS_HOST
              value: numalogic-redis-cluster.numalogic-prometheus.svc.cluster.local
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_AUTH
              value: "5rmmfXtsbL"
    - name: trainer-1
      scale:
        min: 1
        max: 5
      sink:
        udsink:
          container:
            image: quay.io/numaio/numalogic-prometheus/udf:v0.1.0a0
            args:
              - python
              - starter.py
              - udsink
              - train
            env:
              - name: TRACKING_URI
                value: "http://mlflow-service.numalogic-prometheus.svc.cluster.local:5000"
              - name: PROMETHEUS_SERVER
                value: "http://prometheus-service.monitoring.svc.cluster.local:8080"
              - name: REDIS_HOST
                value: numalogic-redis-cluster.numalogic-prometheus.svc.cluster.local
              - name: REDIS_PORT
                value: "6379"
              - name: REDIS_AUTH
                value: "5rmmfXtsbL"
    - name: trainer-2
      scale:
        min: 1
        max: 5
      sink:
        udsink:
          container:
            image: quay.io/numaio/numalogic-prometheus/udf:v0.1.0a0
            args:
              - python
              - starter.py
              - udsink
              - train
            env:
              - name: TRACKING_URI
                value: "http://mlflow-service.numalogic-prometheus.svc.cluster.local:5000"
              - name: PROMETHEUS_SERVER
                value: "http://prometheus-service.monitoring.svc.cluster.local:8080"
              - name: REDIS_HOST
                value: numalogic-redis-cluster.numalogic-prometheus.svc.cluster.local
              - name: REDIS_PORT
                value: "6379"
              - name: REDIS_AUTH
                value: "5rmmfXtsbL"
    - name: trainer-3
      scale:
        min: 1
        max: 5
      sink:
        udsink:
          container:
            image: quay.io/numaio/numalogic-prometheus/udf:v0.1.0a0
            args:
              - python
              - starter.py
              - udsink
              - train
            env:
              - name: TRACKING_URI
                value: "http://mlflow-service.numalogic-prometheus.svc.cluster.local:5000"
              - name: PROMETHEUS_SERVER
                value: "http://prometheus-service.monitoring.svc.cluster.local:8080"
              - name: REDIS_HOST
                value: numalogic-redis-cluster.numalogic-prometheus.svc.cluster.local
              - name: REDIS_PORT
                value: "6379"
              - name: REDIS_AUTH
                value: "5rmmfXtsbL"
    - name: prometheus-pusher
      scale:
        min: 1
        max: 5
      sink:
        udsink:
          container:
            env:
              - name: SKIP_VALIDATION_FAILED
                value: "true"
              - name: "PROMETHEUS_SERVER"
                value: "pushgateway.monitoring.svc.cluster.local:9091"
              - name: "METRICS_LABELS"
                value: "intuit_alert=true"
            image: quay.io/numaio/numaflow-sink/prometheus-pusher
    - name: output
      scale:
        min: 1
        max: 1
      sink:
        log: {}
    - name: training-output
      scale:
        min: 1
        max: 1
      sink:
        log: {}
    - name: input-output
      scale:
        min: 1
        max: 1
      sink:
        log: {}
  edges:
    - from: input
      to: decode
    - from: input
      to: input-output
    - from: decode
      to: filter
    - from: filter
      to: window
    - from: window
      to: preprocess
    - from: preprocess
      to: inference
      conditions:
        keyIn:
          - inference
    - from: preprocess
      to: trainer-1
      conditions:
        keyIn:
          - train
    - from: inference
      to: trainer-2
      conditions:
        keyIn:
          - train
    - from: inference
      to: threshold
      conditions:
        keyIn:
          - threshold
    - from: threshold
      to: trainer-3
      conditions:
        keyIn:
          - threshold
    - from: threshold
      to: postprocess
      conditions:
        keyIn:
          - postprocess
    - from: postprocess
      to: output
    - from: postprocess
      to: prometheus-pusher
